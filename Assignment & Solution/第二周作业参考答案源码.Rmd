---
title: "***-第一周作业"
author: "***"
date: "`r Sys.Date()`"
output:
  rmdformats::readthedown:
    highlight: kate
    css: hpstrcsw.css
    df_print: paged
---

# 正态分布的条件分布
![Caption for the picture.](E:/大三上/Non-Parametric Statistics 王星/Week2 including R pre/pic1.png)

## 数值计算

注意：上述$X_1,X_2$不被限制维度。


根据极大似然，可以计算出来三元正态分布的均值和协方差估计：

$\hat\mu = ({\bar x}_1, {\bar x}_2, {\bar x}_3)$

$\hat{\Sigma} = \frac{1}{N} * \sum\limits_{i=1}^N\{(x^i-\bar{x})(x^i-\bar{x})^T\}$


```{r,message=FALSE,warning=FALSE}
data = read.csv('C:/Users/Lenovo/Desktop/数据盘/unempstates-30years.csv', header = TRUE)
# colnames(data)
# ncol(data);nrow(data)

# 提取数据集中的CA,PA,OR三列做一个multidata
multidata = cbind(matrix(data$CA), matrix(data$PA), matrix(data$OR))
colnames(multidata) = paste0('V', 1:3)

# 先做\mu=(\mu_1,\mu_2,\mu_3)的极大似然估计
mu_mle = apply(multidata, 2, mean); mu_mle

N = nrow(multidata)

# 三元正态分布协方差矩阵的极大似然估计
sigma_mle = t(multidata[,] - mu_mle) %*% (multidata[,] - mu_mle) / N; sigma_mle
```

求解$E(X_1|(X_2, X_3)), Var(X_1|(X_2, X_3))$

求解$E((X_2, X_3)|X_1), Var((X_2, X_3)|X_1)$

```{r,message=FALSE,warning=FALSE}
EVar = function(multidata, x1, x2){
  # example1: x1 = c(1,2); x2 = c(3)
  # example2: x1 = c(2), x2 = c(1, 3)
  
  # 计算三元正态分布的极大似然估计
  mu_mle = apply(multidata, 2, mean); mu_mle
  mu_mle = matrix(mu_mle, ncol = 1)
  
  # multidata - mu_mle不可以直接做，因为R默认按照列来走，而这个减法我们想要按行来走
  # apply(sweep(multidata, 2, mu_mle), 2, mean) 检验sweep是正确的
  
  sigma_mle = t(sweep(multidata, 2, mu_mle)) %*% (sweep(multidata, 2, mu_mle)) / nrow(multidata)
  sigma_mle = matrix(sigma_mle, ncol = 3)
  
  print('----------sigma_11/12/21/22----------')
  print(sigma_mle)
  
  
  # 切分sigma_11 sigma_12 sigma_21 sigma_22
  sigma_11 = sigma_mle[x1, x1];print(sigma_11)
  sigma_12 = matrix(sigma_mle[x1, x2], nrow = length(x1), ncol = length(x2));print(sigma_12)
  sigma_21 = matrix(sigma_mle[x2, x1], nrow = length(x2), ncol = length(x1));print(sigma_21)
  sigma_22 = sigma_mle[x2, x2];print(sigma_22)
  
  print('----------mu_1 mu_2-----------')
  
  # 切分mu_1 mu_2
  mu_1 = matrix(mu_mle[x1], ncol = 1); print(mu_1)
  mu_2 = matrix(mu_mle[x2], ncol = 1); print(mu_2)

  # 根据条件期望满足正态分布的公式计算期望  
  e_cond = mu_1 + sigma_12 %*% solve(sigma_22) %*% (multidata[sample(1:nrow(multidata), 1), x2] - mu_2) 
  # 根据条件期望满足正态分布的公式计算方差
  var_cond = sigma_11 - sigma_12 %*% solve(sigma_22) %*% sigma_21
  print(paste0('系数', sigma_12 %*% solve(sigma_22)))
  
  return (list(e_cond, var_cond))
}

# V1->x1, (V2, V3)->x2
ans1 = EVar(multidata, c(1), c(2, 3))

# (V2, V3)->x1, V1->x2
ans2 = EVar(multidata, c(2, 3), c(1))
```
首先，计算了三元正态分布的期望以及协方差矩阵的极大似然估计，这之中使用到了`apply()`, `t()`等函数，前者对multidata每一列作用，求出$\bar x$。后者在计算协方差矩阵极大似然估计的时候计算了$x^i - \bar x$的转置。另外，矩阵乘法%*%也被使用，目的是计算$x^i - \bar x$和$(x^i - \bar x)^T$的积。

接下来在计算条件期望时，根据结论$E(X_1|X_2) = \mu_1 + \Sigma_{12}\Sigma^{-1}_{22}(X_2-\mu_2)$ 除了`t()`和`apply()`，我们还需要使用`solve()`计算一个矩阵的逆，特别地，这里我们需要计算\Sigma_{22}的逆。

在计算条件方差 $Var(X_1|X_2) = \Sigma_{11} - \Sigma_{12}\Sigma^{-1}_{22}\Sigma_{21}$的时候，也运用到了矩阵转置`t()`, 矩阵求逆`solve()`以及矩阵乘法 `%*%`。


### 答案输出
由于在计算条件期望的时候，还需要输入一个X2的观测值，在上面的函数中，我设置了从multidata中随机抽取一条数据作为X2的输入值，没有安排外部接入。所以下面会直接输出条件期望的结果。
```{r}
print(paste0("----------第一问----------", ans1))
print(paste0("----------第二问----------", ans2))
```

### 公式表达
为了方便阅读，用LaTeX重新打一遍计算出来的结果，下面将在X2上留空。
$$E(V_1|(V_2, V_3)) = 7.20 + (0.62 \quad 0.16) * (X2 - \left(
\begin{array} {4}
6.52\\
7.17
\end{array}
\right))$$

$$Var(V_1|(V_2, V_3)) = 1.267$$

$$E((V_2, V_3)|V_1) = \left(
\begin{array} {5}
6.52 \\ 7.17
\end{array}
\right) + \left(
\begin{array} {6}
0.81\\
0.76 
\end{array}
\right) * (X1 - 7.20)$$

$$
Var((V_2, V_3)|V_1) = \left(
\begin{array} {2}
1.37\quad 1.1 \\
1.1 \quad 1.77
\end{array}
\right)
$$


## 数据绘图题
### 子题一
50个洲的各月份平均失业率提取出来，按月绘制曲线图，分析失业率的变点年份，进行标注（或输出累积平均失业率2D变化曲线图）

```{r,message=FALSE,warning=FALSE}
library(ggplot2)
library(ggthemes)
library(lubridate)
# 日期转换方法 dmy(paste0("01 ", gsub("-", " 19", data$Month)))

aver_permon = apply(data[,2:51],1,mean)
plot(dmy(paste0("01 ", gsub("-", " 19", data$Month))), aver_permon, type = 'l', xlab = '月份', ylab = "平均失业率", main = '美国50州在1950-1984年间平均失业率变化图', ylim = c(0, 12))

turning_points = as.Date(c("1953-04-01", "1957-01-01", "1963-04-01", "1966-03-01", "1974-03-01", "1977-07-01", "1981-03-01", "1984-03-01"))
turning_rates = c(5.344,10.096,5.056,6.926,3.774,5.718,4.174,9.030)

temp = data.frame(Month = dmy(paste0("01 ", gsub("-", " 19", data$Month))), Mean = aver_permon)

loc = data.frame(x = as.Date(rep('1950-01-01', 8)), y = rep(0, 8), tp = turning_points, tr = turning_rates)

ggplot(temp, aes(x = Month, y = Mean))+
  geom_line(lwd = 2)+
  labs(x="Month",y="Mean", title = "50洲各月份失业率平均数变化") +
  scale_x_date(date_break= "5 year") +
  geom_segment(aes(x = tp, y = y, xend = tp, yend = tr),
               data= loc, 
               lty = 2,
               lwd = 1,
               colour = c("antiquewhite","blueviolet","chartreuse","darkorange2","gold","gainsboro","palevioletred1","tan2")) + 
  geom_segment(aes(x = x, y = tr, xend = tp, yend = tr),
               data= loc, 
               lty = 2,
               lwd = 1,
               colour = c("antiquewhite","blueviolet","chartreuse","darkorange2","gold","gainsboro","palevioletred1","tan2")) +
  theme_economist()
```

### 子题二

将失业率的平均值和标准差放在一张图上，并将50个洲的失业率数据作为背景，加注legend，给出从图上观察到的分析结果。

```{r,message=FALSE,warning=FALSE}
sd_permon = apply(data[, 2:51], 1, sd)
plus_sd = aver_permon + sd_permon
minus_sd = aver_permon - sd_permon

plot(1:length(aver_permon), aver_permon, type = 'l', xlab = '月份', ylab = "平均失业率", main = '美国50州在1950-1984年间平均失业率变化图', xlim = c(1,416), ylim = c(0,15), col = 'black', lwd = 5)

for(state_no in 2:51){
  lines(data[, state_no], lty = 4, col = 'grey')
}

lines(plus_sd, lty = 2, col = 'red', lwd = 4)
lines(minus_sd, lty = 2, col = 'blue', lwd = 4)
lines(aver_permon, lty = 1, type = 'l', lwd = 5)

legend("topright", legend = c('mean', 'mean+sd', 'mean-sd', 'states'), lty = c(1, 2, 2, 4), col = c('black', 'red', 'blue', 'grey'), lwd = c(5, 4, 4, 1),cex = 0.7)
```

当然，用ggplot会更加方便一些

```{r,message=FALSE,warning=FALSE}
library(ggplot2)
library(ggthemes)

dat = data.frame(dmy(paste0("01 ", gsub("-", " 19", data$Month))), aver_permon)
colnames(dat) = c("Month", "value")

ggplot(dat, aes(x=Month,y=value))+
  geom_line()+
  geom_ribbon(aes(ymax = value + sd_permon, 
                  ymin = value - sd_permon),
                  alpha = 0.3,
                  fill = "grey70",
                  colour = NA )+
  theme_tufte()


library(reshape2)
adj_data = data.frame(dmy(paste0("01 ", gsub("-", " 19", data$Month))), data[, 2:51])
colnames(adj_data)[1] = "Month"
adj_data = melt(adj_data, id.vars="Month")

ggplot(adj_data, aes(x = Month, y = value)) + 
  geom_line(lty = 1, col = 'grey') + 
  geom_ribbon(aes(ymax = aver_permon + sd_permon, 
                  ymin = aver_permon - sd_permon),
                  data = dat,
                  alpha = 0.6,
                  fill = "#FFC408",
                  colour = NA )+
  geom_line(data = dat, lwd = 3, lty = 1, col = 'blue')+
  labs(x = 'Month', y = '平均失业率', title = '平均失业率变化图')+
  theme_tufte()
```
其中，蓝色线标注了平均失业率，黄色区域是$mean \pm std$，灰色区域则是五十个州的数据所占范围。

从以上这些图像中我们发现
* 失业率升降成周期性变化，周期为十年左右。
* 大部分洲的失业率都在50洲均值的一倍标准差之内。
* 失业率越高，各洲失业率的方差就越大。

# 绘图思考

## The histogram of normalized std
```{r,message=FALSE,warning=FALSE}
set.seed(824)
std_list = seq(-0.75, 1.00, 0.025)
number_list = sort(rnorm(71, 5, 2))
adjust_list = 10^number_list + rexp(71, 0.001)
# number_list = sort(runif(71, 1000, 10^8))
# adjust_list = number_list + rnorm(71, 100, 1000)


ShowPoint = function(x, col_, labels_, lx, ly){
  index = (x + 0.75) / 0.025 + 1
  segments(x, 10, x, adjust_list[index], col = col_, lty = 4, lwd = 2)
  segments(-1.25, adjust_list[index], x, adjust_list[index], col = col_, lty = 4, lwd = 2)
  text(x, adjust_list[index]*2, labels = labels_)
  text(lx, ly, paste0(labels_,"(norm_std=",as.character(x)," num=",as.character(as.integer(adjust_list[index])),")"))
}

plot(std_list, adjust_list, col = 'blue', type = 'l', xlim = c(-1,1), ylim = c(100, max(adjust_list)), log='y', xlab = 'normalized std', ylab = 'the number of samples', main = 'The histogram of normalized std')

ShowPoint(-0.55, "green", "A", 0.6, 6400)
ShowPoint(-0.25, "orange", "B", 0.6, 1600)
ShowPoint(0.25, "red", "C", 0.6, 400)
ShowPoint(0.95, "purple", "D", 0.6, 100)

```

## 2D histogram of normalized std and loss
```{r,message=FALSE,warning=FALSE}
library(ggplot2)
library(ggthemes)

y = runif(10^6,0,2)
x = rep(0, 10^6)
for(i in 1:10^6)
  x[i] = rnorm(1, 1 - cos(0 - y[i]) * 1.5, sqrt(y[i]/3))


data <- data.frame(x, y)

loc = data.frame(tp = c(-2, 0, 1.8), tr = c(1, 1.4, 1.2))

ggplot(data, aes(x = x, y = y)) +
  geom_bin2d(binwidth = 0.01) + 
  scale_fill_gradient2(low="blue", high = "darkgreen") + 
  geom_segment(aes(x = tp, y = rep(0,3), xend = tp, yend = tr),
               data= loc, 
               lty = 2,
               lwd = 1,
               colour = c("tan2","blueviolet","chartreuse")) + 
  geom_segment(aes(x = rep(-3, 3), y = tr, xend = tp, yend = tr),
               data= loc, 
               lty = 2,
               lwd = 1,
               colour = c("tan2","blueviolet","chartreuse")) +
  geom_text(aes(x = tp, y = tr),
            data = loc,
            label = c("A(-2,1) num:0","B(0,1.4) num:132","C(1.8,1.2) num:51"),
            size = 5,
            hjust = 0, nudge_x = 0.05) + 
  labs(x = 'normalized std', y = 'loss') + 
  theme_grey()
  

```

## Perceived Age v.s. Real Age
```{r,message=FALSE,warning=FALSE}
real_age = seq(0, 100, 2)
perceived_age_asian = 
  c(25, 21, 20, 21, 22, 20, 19, 22, 23, 20, 25, 27, 25, 23, 29, 31, 32, 28, 34, 40, 38, 36, 39, 37, 43, 39, 42, 45, 46, 48, 53, 49, 50, 52, 54, 48, 49, 52, 53, 47, 56, 57, 59, 54, 61, 55, 56, 58, 62, 60, 57)
perceived_age_caucasian = 
  c(25, 27, 26, 24, 23, 25, 26, 25, 27, 25, 27, 25, 28, 24, 27, 30, 28, 31, 32, 35, 38, 36, 39, 37, 41, 40, 43, 46, 44, 45, 47, 47, 52, 53, 51, 49, 48, 54, 56, 48, 52, 59, 61, 57, 62, 56, 50, 59, 63, 61, 59)
perceived_age_afro = 
  c(25, 26, 24, 20, 22, 21, 19, 21, 20, 22, 23, 25, 24, 26, 22, 30, 33, 27, 35, 36, 34, 32, 33, 35, 40, 39, 41, 42, 39, 41, 44, 46, 48, 54, 56, 46, 43, 50, 49, 47, 56, 57, 59, 54, 61, 44, 58, 57, 63, 58, 55)
ground_truth = seq(0, 100, 2)

noise1 = data.frame(real_age, "value" = perceived_age_asian, "noise" = rnorm(length(perceived_age_asian), 5.0, 2.7))
noise2 = data.frame(real_age, "value" = perceived_age_caucasian, "noise" = rnorm(length(perceived_age_caucasian), 5.3, 2.6))
noise3 = data.frame(real_age, "value" = perceived_age_afro, "noise" = rnorm(length(perceived_age_afro), 5.2, 2.8))

mws = data.frame(real_age, "Asian" = perceived_age_asian, "Caucasian" = perceived_age_caucasian, "Afro-American" = perceived_age_afro)

library(reshape2)
mws = melt(mws, id.vars="real_age")

  
ggplot(mws, aes(x = real_age, y = value, colour = variable), lty = c(2, 1, 1, 1)) +
  stat_smooth(method = "loess", span = 0.3, se=TRUE, aes(fill = variable), alpha = 0.3) +
  theme_bw()
  
ggplot(mws, aes(x = real_age, y = value, colour = variable)) + 
  geom_abline(slope = 1, intercept = 0, lty = 2, lwd = 2) +
  geom_line(lty = 1, lwd = 1, type = 'l') +
  geom_ribbon(aes(ymax = value + noise, 
                  ymin = value - noise),
                  data = noise2,
                  alpha = 0.3,
                  fill = "lightgreen",
                  colour = NA ) + 
  geom_ribbon(aes(ymax = value + noise, 
                  ymin = value - noise),
                  data = noise3,    
                  alpha = 0.3,
                  fill = "lightblue",
                  colour = NA ) + 
  geom_ribbon(aes(ymax = value + noise, 
                  ymin = value - noise),
                  data = noise1,
                  alpha = 0.3,
                  fill = "#FFC408",
                  colour = NA ) +   
  scale_x_continuous(limits = c(0,100)) +
  scale_y_continuous(limits = c(0,100)) + 
  labs(x = "Real Age", y = "Perceived Age") + 
  theme_foundation()

  ##补充利用basicTrendline
  library(basicTrendline)
  attach(mtcars)
  trendline(mpg, wt, model="line2P", ePos.x = "topright",summary = FALSE, 
            eDigit=5,yhat=TRUE,xname='X', yname='Y')
  #这个包绘制出的图可以依然使用graphics基础包里的各种函数添加元素，
  #比如legend等

```